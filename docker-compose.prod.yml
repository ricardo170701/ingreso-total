version: "3.9"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile2
    container_name: escaner_total_app_prod
    restart: always
    # Solo exponer en localhost, usar nginx reverse proxy
    ports:
      - "127.0.0.1:8181:80"
    environment:
      # Aplicación
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:-https://tu-dominio.com}

      # Base de datos
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-escaner_total_prod}
      DB_USERNAME: ${DB_USERNAME:-escaner_user_prod}
      DB_PASSWORD: ${DB_PASSWORD}

      # Logging
      LOG_CHANNEL: ${LOG_CHANNEL:-stack}
      LOG_LEVEL: ${LOG_LEVEL:-error}

      # Cache y Sesiones
      CACHE_DRIVER: ${CACHE_DRIVER:-file}
      SESSION_DRIVER: ${SESSION_DRIVER:-file}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-sync}

      # Docker - Desactivar migraciones/seeders automáticos en producción
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-false}
      RUN_SEEDERS: ${RUN_SEEDERS:-false}
      SEEDER_CLASS: ${SEEDER_CLASS:-Database\\Seeders\\DatabaseSeeder}

      # API Keys
      ACCESS_DEVICE_KEY: ${ACCESS_DEVICE_KEY}
      DOOR_API_KEY: ${DOOR_API_KEY}
      DOOR_EMERGENCY_PORT: ${DOOR_EMERGENCY_PORT:-8000}

      # OpenAI (opcional)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # Mail
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Escáner Total}

      # Swagger
      L5_SWAGGER_CONST_HOST: ${APP_URL}

    volumes:
      - storage_data:/var/www/html/storage
      - ./storage/app:/var/www/html/storage/app
      - ./storage/logs:/var/www/html/storage/logs
    depends_on:
      db:
        condition: service_healthy
    networks:
      - escaner_net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  db:
    image: mysql:8.0
    container_name: escaner_total_db_prod
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-escaner_total_prod}
      MYSQL_USER: ${DB_USERNAME:-escaner_user_prod}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    # Solo exponer en localhost para seguridad
    ports:
      - "127.0.0.1:${DB_EXTERNAL_PORT:-3307}:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./backups:/backups
    networks:
      - escaner_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - --default-authentication-plugin=mysql_native_password
      - --max_connections=200
      - --innodb_buffer_pool_size=1G
      - --innodb_log_file_size=256M
      - --max_allowed_packet=64M
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # Nginx reverse proxy (opcional pero recomendado)
  nginx:
    image: nginx:alpine
    container_name: escaner_total_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - app
    networks:
      - escaner_net
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  escaner_net:
    driver: bridge

volumes:
  db_data:
    driver: local
  storage_data:
    driver: local

